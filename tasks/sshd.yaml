# sshd

- name: Set authorized key taken from file
  authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ item }}"
  with_file:
    - "{{ ssh_pub_key_path }}"

- name: Set authorized key taken from file to root
  authorized_key:
    user: root
    state: present
    key: "{{ item }}"
  with_file:
    - "{{ ssh_pub_key_path }}"
  when: enable_root_login

- name: Ensure correct ssh directory permissions
  file:
    path: "~/.ssh"
    state: directory
    mode: 0700

- name: Ensure correct authorized_keys permissions
  file:
    path: "~/.ssh/authorized_keys"
    state: touch
    mode: 0600

- name: Ensure PubkeyAuthentication is set to yes
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^PubkeyAuthentication"
    line: "PubkeyAuthentication yes"
    state: present

- name: Ensure AuthorizedKeysFile is set correctly
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^AuthorizedKeysFile"
    line: "AuthorizedKeysFile .ssh/authorized_keys"
    state: present

- name: Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication no"
    state: present
  when: disable_password_login

- name: Enable root login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^PermitRootLogin"
    line: "PermitRootLogin yes"
    state: present
  when: enable_root_login

- name: Reload ssh service
  service:
    name: ssh
    state: reloaded
